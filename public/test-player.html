<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CAT-alog Proxy Test Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 16px;
      background: #0b1120;
      color: #e5e7eb;
    }
    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .panel {
      background: #020617;
      border: 1px solid #1e293b;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9rem;
    }
    input, select {
      background: #020617;
      border: 1px solid #1e293b;
      color: #e5e7eb;
      padding: 6px 8px;
      border-radius: 4px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 8px;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 500;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    video {
      width: 100%;
      max-width: 900px;
      background: black;
    }
    pre {
      background: #020617;
      border-radius: 6px;
      padding: 8px;
      max-height: 240px;
      overflow: auto;
      font-size: 0.85rem;
    }
    .row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
    }
    small {
      color: #9ca3af;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>
</head>
<body>
  <h1>CAT-alog Proxy Test Player</h1>
  <div class="panel">
    <form id="stream-form">
      <div class="row">
        <div>
          <label>
            Type
            <select id="type" name="type">
              <option value="movie" selected>Movie</option>
              <option value="tv">TV</option>
              <option value="anime">Anime</option>
            </select>
          </label>
        </div>
        <div>
          <label>
            Provider (v2)
            <select id="provider" name="provider">
              <option value="vidlink" selected>CAT-alog (VidLink)</option>
              <option value="filmex">Filmex (fmovies4u)</option>
            </select>
          </label>
        </div>
        <div>
          <label>
            TMDB ID (movie / tv)
            <input id="tmdbId" name="tmdbId" placeholder="786892" />
          </label>
        </div>
        <div>
          <label>
            Season (tv)
            <input id="season" name="season" placeholder="1" />
          </label>
        </div>
        <div>
          <label>
            Episode (tv)
            <input id="episode" name="episode" placeholder="1" />
          </label>
        </div>
        <div>
          <label>
            MAL ID (anime)
            <input id="malId" name="malId" placeholder="12345" />
          </label>
        </div>
        <div>
          <label>
            Number (anime ep)
            <input id="number" name="number" placeholder="1" />
          </label>
        </div>
        <div>
          <label>
            Sub or Dub (anime)
            <input id="subOrDub" name="subOrDub" placeholder="sub | dub" />
          </label>
        </div>
      </div>
      <div style="margin-top: 8px; display: flex; gap: 8px; align-items: center;">
        <button type="submit" id="play-btn">Resolve & Play</button>
        <small>
          Example: movie 786892. Proxy is expected on the same origin (e.g. http://localhost:4000).
        </small>
      </div>
    </form>
  </div>

  <div class="panel">
    <video id="video" controls></video>
  </div>

  <div class="panel">
    <div><strong>Last /stream response</strong></div>
    <pre id="output"></pre>
  </div>

  <script>
    const form = document.getElementById('stream-form');
    const typeEl = document.getElementById('type');
    const providerEl = document.getElementById('provider');
    const tmdbIdEl = document.getElementById('tmdbId');
    const seasonEl = document.getElementById('season');
    const episodeEl = document.getElementById('episode');
    const malIdEl = document.getElementById('malId');
    const numberEl = document.getElementById('number');
    const subOrDubEl = document.getElementById('subOrDub');
    const outputEl = document.getElementById('output');
    const videoEl = document.getElementById('video');
    const playBtn = document.getElementById('play-btn');

    // Default example
    tmdbIdEl.value = '786892';

    let hls;

    function setLoading(loading) {
      playBtn.disabled = loading;
      playBtn.textContent = loading ? 'Resolvingâ€¦' : 'Resolve & Play';
    }

    function logResponse(obj) {
      outputEl.textContent = JSON.stringify(obj, null, 2);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setLoading(true);
      try {
        const type = typeEl.value;
        const provider = (providerEl.value || 'vidlink').toLowerCase();
        const params = new URLSearchParams();
        params.set('type', type);
        params.set('provider', provider);

        if (type === 'movie') {
          if (!tmdbIdEl.value) {
            throw new Error('tmdbId is required for movie');
          }
          params.set('tmdbId', tmdbIdEl.value.trim());
        } else if (type === 'tv') {
          if (!tmdbIdEl.value || !seasonEl.value || !episodeEl.value) {
            throw new Error('tmdbId, season and episode are required for tv');
          }
          params.set('tmdbId', tmdbIdEl.value.trim());
          params.set('season', seasonEl.value.trim());
          params.set('episode', episodeEl.value.trim());
        } else if (type === 'anime') {
          if (!malIdEl.value || !numberEl.value || !subOrDubEl.value) {
            throw new Error('malId, number and subOrDub are required for anime');
          }
          if (provider === 'filmex') {
            throw new Error('Provider "filmex" does not support anime. Please use CAT-alog (VidLink) for anime.');
          }
          params.set('malId', malIdEl.value.trim());
          params.set('number', numberEl.value.trim());
          params.set('subOrDub', subOrDubEl.value.trim().toLowerCase());
        }

        const url = '/v2/stream?' + params.toString();

        let data;
        try {
          const res = await fetch(url);
          data = await res.json();
        } catch (networkErr) {
          logResponse({
            ok: false,
            error: 'network_error',
            message:
              'Failed to contact the proxy server. Make sure it is running (e.g. http://localhost:4000) and that CORS/network settings allow access.',
            details: {
              error: String(networkErr && networkErr.message ? networkErr.message : networkErr)
            }
          });
          throw networkErr;
        }

        logResponse(data);

        if (!data.ok || !data.url) {
          const humanMessage =
            data.message ||
            data.error ||
            'The proxy responded with an error while resolving the stream.';
          alert(humanMessage);
          return;
        }

        if (hls) {
          hls.destroy();
          hls = null;
        }

        videoEl.pause();
        videoEl.removeAttribute('src');
        videoEl.load();

        const streamUrl = data.url;

        if (window.Hls && window.Hls.isSupported()) {
          hls = new Hls();
          hls.loadSource(streamUrl);
          hls.attachMedia(videoEl);
          hls.on(Hls.Events.MANIFEST_PARSED, function () {
            videoEl.play().catch(() => {});
          });
        } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
          videoEl.src = streamUrl;
          videoEl.play().catch(() => {});
        } else {
          alert('HLS not supported in this browser.');
        }
      } catch (err) {
        logResponse({
          ok: false,
          error: 'frontend_error',
          message:
            'An unexpected error occurred in the test player while trying to resolve or play the stream.',
          details: {
            error: String(err && err.message ? err.message : err)
          }
        });
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>